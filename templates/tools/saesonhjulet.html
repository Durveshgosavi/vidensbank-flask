{% extends "base.html" %}

{% block title %}Sæsonhjulet – Professionel Indkøbsstrategi | Canteen Buddy{% endblock %}

{% block content %}
<!-- Minimalist Hero -->
<header class="relative h-[50vh] min-h-[400px] flex items-center justify-center overflow-hidden bg-stone-900">
    <div class="absolute inset-0 z-0">
        <img src="{{ url_for('static', filename='images/seasonal_fruit.jpg') }}" alt="Sæson"
            class="w-full h-full object-cover opacity-30 grayscale">
        <div class="absolute inset-0 bg-gradient-to-b from-stone-900/60 via-stone-900/40 to-stone-900"></div>
    </div>

    <div class="relative z-10 text-center text-white px-6">
        <p class="text-xs font-bold tracking-[0.2em] uppercase mb-4 text-stone-400">Værktøj til Køkkenet</p>
        <h1 class="font-display text-5xl md:text-7xl font-light tracking-tight mb-6 text-white">Sæsonhjulet</h1>
        <p class="font-sans text-lg font-light text-stone-400 max-w-xl mx-auto">
            Strategisk overblik over råvarekvalitet, pris og klima.
            <br>Optimer dine indkøb med data.
        </p>
    </div>
</header>

<!-- Dashboard Section -->
<section class="py-12 bg-stone-50 min-h-screen font-sans">
    <div class="max-w-7xl mx-auto px-6">

        <!-- Controls Toolbar -->
        <div
            class="flex flex-col md:flex-row items-center justify-between gap-6 mb-12 sticky top-4 z-30 bg-white/95 backdrop-blur-md p-4 rounded-xl shadow-sm border border-stone-200">

            <!-- Month Selector -->
            <div class="flex flex-wrap justify-center gap-1">
                {% for month in ['JAN', 'FEB', 'MAR', 'APR', 'MAJ', 'JUN', 'JUL', 'AUG', 'SEP', 'OKT', 'NOV', 'DEC'] %}
                <button onclick="setMonth({{ loop.index0 }})" id="btn-{{ loop.index0 }}"
                    class="px-3 py-2 rounded-lg text-xs font-bold transition-all duration-200 focus:outline-none border border-transparent
                         {{ 'bg-stone-900 text-white shadow-md' if loop.index0 == 0 else 'text-stone-500 hover:bg-stone-100 hover:text-stone-900' }}">
                    {{ month }}
                </button>
                {% endfor %}
            </div>

            <!-- View Toggle -->
            <div class="flex items-center bg-stone-100 rounded-lg p-1 border border-stone-200">
                <button onclick="setViewMode('simple')" id="btn-simple"
                    class="px-6 py-2 rounded-md text-xs font-bold uppercase tracking-wider transition-all bg-white shadow-sm text-stone-900 border border-stone-200">
                    Oversigt
                </button>
                <button onclick="setViewMode('pro')" id="btn-pro"
                    class="px-6 py-2 rounded-md text-xs font-bold uppercase tracking-wider transition-all text-stone-500 hover:text-stone-900">
                    Analyse
                </button>
            </div>
        </div>

        <!-- Strategy Context Banner -->
        <div id="strategy-banner"
            class="mb-12 p-6 bg-stone-900 rounded-xl text-white shadow-lg hidden opacity-0 transition-all duration-500">
            <div class="flex items-start gap-4">
                <div class="p-3 bg-stone-800 rounded-lg">
                    <svg class="w-6 h-6 text-cb-green-medium" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                    </svg>
                </div>
                <div>
                    <h3 class="text-sm font-bold uppercase tracking-widest text-stone-400 mb-1">Månedens Strategi</h3>
                    <p class="text-lg font-light text-stone-200 italic" id="strategy-text"></p>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div id="content-area" class="transition-opacity duration-300">
            <!-- Simple View (Cards) -->
            <div id="simple-view" class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <!-- Populated by JS -->
            </div>

            <!-- Pro View (Table) -->
            <div id="pro-view" class="hidden bg-white rounded-xl shadow-sm border border-stone-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead
                            class="bg-stone-50 text-stone-500 font-bold uppercase tracking-wider text-xs border-b border-stone-200">
                            <tr>
                                <th class="px-6 py-4">Råvare</th>
                                <th class="px-6 py-4">Kategori</th>
                                <th class="px-6 py-4">Oprindelse</th>
                                <th class="px-6 py-4">Status</th>
                                <th class="px-6 py-4 text-center">Pris</th>
                                <th class="px-6 py-4 text-center">Klima</th>
                                <th class="px-6 py-4 text-center">Kvalitet</th>
                                <th class="px-6 py-4 text-right">Anbefaling</th>
                            </tr>
                        </thead>
                        <tbody id="pro-table-body" class="divide-y divide-stone-100">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</section>

<script>
    // Data Model
    // origin: 'DK', 'EU', 'World'
    // price: 1 (Low/Best), 2 (Med), 3 (High/Worst) -> Lower is better for score
    // climate: 1 (Low/Best), 2 (Med), 3 (High/Worst) -> Lower is better for score
    // quality: 3 (Peak), 2 (Good), 1 (Tired/Storage) -> Higher is better for score
    // status: 'Sæsonstart', 'Højsæson', 'Sæsonafslutning', 'Lager'

    const seasonData = [
        // Jan (0)
        {
            items: [
                { name: "Kål (Alle typer)", category: "Grønt", origin: "DK", price: 1, climate: 1, quality: 3, status: "Højsæson" },
                { name: "Gulerødder", category: "Grønt", origin: "DK", price: 1, climate: 1, quality: 2, status: "Lager" },
                { name: "Pastinak", category: "Grønt", origin: "DK", price: 1, climate: 1, quality: 2, status: "Lager" },
                { name: "Rødbede", category: "Grønt", origin: "DK", price: 1, climate: 1, quality: 2, status: "Lager" },
                { name: "Løg", category: "Grønt", origin: "DK", price: 1, climate: 1, quality: 2, status: "Lager" },
                { name: "Æbler", category: "Frugt", origin: "DK", price: 2, climate: 1, quality: 1, status: "Lager" },
                { name: "Pærer", category: "Frugt", origin: "DK", price: 2, climate: 1, quality: 1, status: "Lager" },
                { name: "Appelsiner", category: "Frugt", origin: "EU", price: 1, climate: 2, quality: 3, status: "Højsæson" },
                { name: "Torsk", category: "Fisk", origin: "DK", price: 2, climate: 1, quality: 3, status: "Højsæson" },
                { name: "Muslinger", category: "Fisk", origin: "DK", price: 1, climate: 1, quality: 3, status: "Højsæson" },
                { name: "Østers", category: "Fisk", origin: "DK", price: 3, climate: 1, quality: 3, status: "Højsæson" }
            ],
            strategy: "Fokusér på grove grøntsager og kål. Dansk frugt er på retur kvalitetsmæssigt, så suppler med sydeuropæisk citrus."
        },
        // Feb (1)
        {
            items: [
                { name: "Kål (Rød/Hvid)", category: "Grønt", origin: "DK", price: 1, climate: 1, quality: 2, status: "Lager" },
                { name: "Porrer", category: "Grønt", origin: "DK", price: 2, climate: 1, quality: 2, status: "Sæsonafslutning" },
                { name: "Gulerødder", category: "Grønt", origin: "DK", price: 1, climate: 1, quality: 2, status: "Lager" },
                { name: "Æbler", category: "Frugt", origin: "EU", price: 2, climate: 2, quality: 3, status: "Højsæson" },
                { name: "Appelsiner", category: "Frugt", origin: "EU", price: 1, climate: 2, quality: 3, status: "Højsæson" },
                { name: "Bananer", category: "Frugt", origin: "World", price: 1, climate: 2, quality: 2, status: "Helår" },
                { name: "Stenbiderrogn", category: "Fisk", origin: "DK", price: 3, climate: 1, quality: 3, status: "Sæsonstart" },
                { name: "Torsk", category: "Fisk", origin: "DK", price: 2, climate: 1, quality: 3, status: "Højsæson" },
                { name: "Skrubbe", category: "Fisk", origin: "DK", price: 1, climate: 1, quality: 3, status: "Højsæson" }
            ],
            strategy: "Dansk lager er i bund. Det er acceptabelt at skifte til europæisk frugt for at opretholde kvaliteten."
        },
        // Nov (10) - Example for contrast
        {
            items: [
                { name: "Rosenkål", category: "Grønt", origin: "DK", price: 2, climate: 1, quality: 3, status: "Sæsonstart" },
                { name: "Rodfrugter", category: "Grønt", origin: "DK", price: 1, climate: 1, quality: 3, status: "Højsæson" },
                { name: "Grønkål", category: "Grønt", origin: "DK", price: 1, climate: 1, quality: 3, status: "Højsæson" },
                { name: "Æbler", category: "Frugt", origin: "DK", price: 1, climate: 1, quality: 3, status: "Højsæson" },
                { name: "Klementiner", category: "Frugt", origin: "EU", price: 2, climate: 2, quality: 3, status: "Sæsonstart" },
                { name: "Muslinger", category: "Fisk", origin: "DK", price: 1, climate: 1, quality: 3, status: "Højsæson" },
                { name: "Torsk", category: "Fisk", origin: "DK", price: 2, climate: 1, quality: 3, status: "Højsæson" }
            ],
            strategy: "Dansk højsæson. Brug danske æbler og rodfrugter. De er billigst, bedst og mest klimavenlige nu."
        }
        // ... (Ideally all months would be filled, using simplified dataset for demo)
    ];

    // Fill missing months with generic data to prevent errors
    for (let i = 0; i < 12; i++) {
        if (!seasonData[i]) {
            seasonData[i] = {
                items: [
                    { name: "Sæsonvare", category: "Grønt", origin: "DK", price: 2, climate: 1, quality: 2, status: "Generel" }
                ],
                strategy: "Generel sæsonanbefaling."
            };
        }
    }

    let currentViewMode = 'simple';
    let currentMonthIndex = new Date().getMonth();

    function setMonth(monthIndex) {
        currentMonthIndex = monthIndex;

        // Update Buttons
        document.querySelectorAll('button[id^="btn-"]').forEach((btn, idx) => {
            if (idx === monthIndex) {
                btn.className = "px-3 py-2 rounded-lg text-xs font-bold transition-all duration-200 focus:outline-none border border-transparent bg-stone-900 text-white shadow-md transform scale-105";
            } else {
                btn.className = "px-3 py-2 rounded-lg text-xs font-bold transition-all duration-200 focus:outline-none border border-transparent text-stone-500 hover:bg-stone-100 hover:text-stone-900";
            }
        });

        renderContent();
    }

    function setViewMode(mode) {
        currentViewMode = mode;

        const btnSimple = document.getElementById('btn-simple');
        const btnPro = document.getElementById('btn-pro');
        const simpleView = document.getElementById('simple-view');
        const proView = document.getElementById('pro-view');
        const strategyBanner = document.getElementById('strategy-banner');

        if (mode === 'simple') {
            btnSimple.className = "px-6 py-2 rounded-md text-xs font-bold uppercase tracking-wider transition-all bg-white shadow-sm text-stone-900 border border-stone-200";
            btnPro.className = "px-6 py-2 rounded-md text-xs font-bold uppercase tracking-wider transition-all text-stone-500 hover:text-stone-900";

            simpleView.classList.remove('hidden');
            proView.classList.add('hidden');
            strategyBanner.classList.add('hidden');
            strategyBanner.classList.remove('opacity-100');
        } else {
            btnPro.className = "px-6 py-2 rounded-md text-xs font-bold uppercase tracking-wider transition-all bg-white shadow-sm text-stone-900 border border-stone-200";
            btnSimple.className = "px-6 py-2 rounded-md text-xs font-bold uppercase tracking-wider transition-all text-stone-500 hover:text-stone-900";

            simpleView.classList.add('hidden');
            proView.classList.remove('hidden');
            strategyBanner.classList.remove('hidden');
            // Small delay for fade in
            setTimeout(() => strategyBanner.classList.add('opacity-100'), 50);
        }

        renderContent();
    }

    function calculateScore(item) {
        // Lower price/climate is better. Higher quality is better.
        // Normalize to 0-1 scale where 1 is best.

        const priceScore = (4 - item.price) / 3; // 1->1.0, 2->0.66, 3->0.33
        const climateScore = (4 - item.climate) / 3;
        const qualityScore = item.quality / 3;

        // Weighted Score: 40% Price, 40% Quality, 20% Climate
        return (priceScore * 0.4) + (qualityScore * 0.4) + (climateScore * 0.2);
    }

    function getBadgeColor(type, value) {
        if (type === 'price' || type === 'climate') {
            if (value === 1) return 'bg-green-100 text-green-800';
            if (value === 2) return 'bg-yellow-100 text-yellow-800';
            return 'bg-red-100 text-red-800';
        }
        if (type === 'quality') {
            if (value === 3) return 'bg-green-100 text-green-800';
            if (value === 2) return 'bg-yellow-100 text-yellow-800';
            return 'bg-stone-100 text-stone-600';
        }
        return 'bg-stone-100 text-stone-800';
    }

    function getText(type, value) {
        if (type === 'price') return ['Lav', 'Mellem', 'Høj'][value - 1];
        if (type === 'climate') return ['Lav', 'Mellem', 'Høj'][value - 1];
        if (type === 'quality') return ['Lav', 'God', 'Top'][value - 1];
        return '';
    }

    function renderContent() {
        const data = seasonData[currentMonthIndex];
        document.getElementById('strategy-text').textContent = data.strategy;

        // Sort items by Score (Best first)
        const sortedItems = [...data.items].sort((a, b) => calculateScore(b) - calculateScore(a));

        if (currentViewMode === 'simple') {
            renderSimpleView(sortedItems);
        } else {
            renderProView(sortedItems);
        }
    }

    function renderSimpleView(items) {
        const container = document.getElementById('simple-view');
        const categories = { 'Grønt': [], 'Frugt': [], 'Fisk': [] };

        items.forEach(item => {
            if (categories[item.category]) categories[item.category].push(item);
        });

        let html = '';
        for (const [cat, catItems] of Object.entries(categories)) {
            if (catItems.length === 0) continue;

            html += `
            <div class="bg-white rounded-xl p-6 shadow-sm border border-stone-100">
                <h3 class="font-display text-xl text-stone-900 mb-4 border-b border-stone-100 pb-2">${cat}</h3>
                <ul class="space-y-3">
                    ${catItems.map(item => `
                        <li class="flex items-center justify-between text-sm">
                            <span class="text-stone-700 font-medium">${item.name}</span>
                            ${item.quality === 3 ? '<span class="px-2 py-0.5 bg-stone-900 text-white text-[10px] font-bold uppercase tracking-wider rounded">Top</span>' : ''}
                        </li>
                    `).join('')}
                </ul>
            </div>
          `;
        }
        container.innerHTML = html;
    }

    function renderProView(items) {
        const tbody = document.getElementById('pro-table-body');

        tbody.innerHTML = items.map((item, index) => {
            const score = calculateScore(item);
            const isBestBuy = index === 0; // Since it's sorted

            return `
            <tr class="hover:bg-stone-50 transition-colors ${isBestBuy ? 'bg-green-50/50' : ''}">
                <td class="px-6 py-4 font-medium text-stone-900 flex items-center gap-2">
                    ${item.name}
                    ${isBestBuy ? '<span class="px-2 py-0.5 bg-green-600 text-white text-[10px] font-bold uppercase tracking-wider rounded shadow-sm">Best Buy</span>' : ''}
                </td>
                <td class="px-6 py-4 text-stone-500">${item.category}</td>
                <td class="px-6 py-4">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-stone-100 text-stone-800">
                        ${item.origin}
                    </span>
                </td>
                <td class="px-6 py-4 text-stone-500">${item.status}</td>
                <td class="px-6 py-4 text-center">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getBadgeColor('price', item.price)}">
                        ${getText('price', item.price)}
                    </span>
                </td>
                <td class="px-6 py-4 text-center">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getBadgeColor('climate', item.climate)}">
                        ${getText('climate', item.climate)}
                    </span>
                </td>
                <td class="px-6 py-4 text-center">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getBadgeColor('quality', item.quality)}">
                        ${getText('quality', item.quality)}
                    </span>
                </td>
                <td class="px-6 py-4 text-right font-mono text-xs text-stone-400">
                    ${(score * 100).toFixed(0)}%
                </td>
            </tr>
          `;
        }).join('');
    }

    // Init
    setMonth(currentMonthIndex);
</script>
{% endblock %}