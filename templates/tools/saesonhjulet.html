{% extends "base.html" %}

{% block title %}Sæsonhjulet – Professionel Indkøbsstrategi | Canteen Buddy{% endblock %}

{% block content %}
<!-- Minimalist Hero -->
<header class="relative h-[50vh] min-h-[400px] flex items-center justify-center overflow-hidden bg-stone-900">
    <div class="absolute inset-0 z-0">
        <img src="{{ url_for('static', filename='images/seasonal_fruit.jpg') }}" alt="Sæson"
            class="w-full h-full object-cover opacity-30 grayscale">
        <div class="absolute inset-0 bg-gradient-to-b from-stone-900/60 via-stone-900/40 to-stone-900"></div>
    </div>

    <div class="relative z-10 text-center text-white px-6">
        <p class="text-xs font-bold tracking-[0.2em] uppercase mb-4 text-stone-400">Værktøj til Køkkenet</p>
        <h1 class="font-display text-5xl md:text-7xl font-light tracking-tight mb-6 text-white">Sæsonhjulet</h1>
        <p class="font-sans text-lg font-light text-stone-400 max-w-xl mx-auto">
            Strategisk overblik over råvarekvalitet, pris og klima.
            <br>Optimer dine indkøb med data.
        </p>
    </div>
</header>

<!-- Dashboard Section -->
<section class="py-12 bg-stone-50 min-h-screen font-sans">
    <div class="max-w-7xl mx-auto px-6">

        <!-- Controls Toolbar -->
        <div
            class="flex flex-col xl:flex-row items-center justify-between gap-6 mb-12 sticky top-4 z-30 bg-white/95 backdrop-blur-md p-4 rounded-xl shadow-sm border border-stone-200">

            <!-- Month Selector -->
            <div class="flex flex-wrap justify-center gap-1 order-2 xl:order-1">
                {% for month in ['JAN', 'FEB', 'MAR', 'APR', 'MAJ', 'JUN', 'JUL', 'AUG', 'SEP', 'OKT', 'NOV', 'DEC'] %}
                <button onclick="setMonth({{ loop.index0 }})" id="btn-{{ loop.index0 }}"
                    class="px-3 py-2 rounded-lg text-xs font-bold transition-all duration-200 focus:outline-none border border-transparent
                         {{ 'bg-stone-900 text-white shadow-md' if loop.index0 == 0 else 'text-stone-500 hover:bg-stone-100 hover:text-stone-900' }}">
                    {{ month }}
                </button>
                {% endfor %}
            </div>

            <div class="flex items-center gap-4 order-1 xl:order-2 w-full xl:w-auto">
                <!-- Search -->
                <div class="relative flex-grow xl:flex-grow-0">
                    <input type="text" id="search-input" placeholder="Søg råvare..." oninput="updateFilters()"
                        class="w-full xl:w-48 pl-9 pr-4 py-2 rounded-lg text-sm border border-stone-200 focus:border-stone-900 focus:ring-0 transition-colors bg-stone-50 focus:bg-white">
                    <svg class="w-4 h-4 text-stone-400 absolute left-3 top-1/2 transform -translate-y-1/2" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>

                <!-- Sort -->
                <select id="sort-select" onchange="updateFilters()"
                    class="pl-3 pr-8 py-2 rounded-lg text-sm border border-stone-200 focus:border-stone-900 focus:ring-0 transition-colors bg-stone-50 focus:bg-white cursor-pointer">
                    <option value="score">Bedste Match</option>
                    <option value="co2">Laveste CO2</option>
                    <option value="price">Laveste Pris</option>
                </select>

                <!-- View Toggle -->
                <div class="flex items-center bg-stone-100 rounded-lg p-1 border border-stone-200 shrink-0">
                    <button onclick="setViewMode('simple')" id="btn-simple"
                        class="px-4 py-2 rounded-md text-xs font-bold uppercase tracking-wider transition-all bg-white shadow-sm text-stone-900 border border-stone-200">
                        Oversigt
                    </button>
                    <button onclick="setViewMode('pro')" id="btn-pro"
                        class="px-4 py-2 rounded-md text-xs font-bold uppercase tracking-wider transition-all text-stone-500 hover:text-stone-900">
                        Analyse
                    </button>
                </div>
            </div>
        </div>

        <!-- Strategy Context Banner -->
        <div id="strategy-banner"
            class="mb-12 p-6 bg-stone-900 rounded-xl text-white shadow-lg hidden opacity-0 transition-all duration-500">
            <div class="flex items-start gap-4">
                <div class="p-3 bg-stone-800 rounded-lg">
                    <svg class="w-6 h-6 text-cb-green-medium" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                    </svg>
                </div>
                <div>
                    <h3 class="text-sm font-bold uppercase tracking-widest text-stone-400 mb-1">Månedens Strategi</h3>
                    <p class="text-lg font-light text-stone-200 italic" id="strategy-text"></p>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div id="content-area" class="transition-opacity duration-300">
            <!-- Simple View (Cards) -->
            <div id="simple-view" class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <!-- Populated by JS -->
            </div>

            <!-- Pro View (Table) -->
            <div id="pro-view" class="hidden bg-white rounded-xl shadow-sm border border-stone-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead
                            class="bg-stone-50 text-stone-500 font-bold uppercase tracking-wider text-xs border-b border-stone-200">
                            <tr>
                                <th class="px-6 py-4">Råvare</th>
                                <th class="px-6 py-4">Kategori</th>
                                <th class="px-6 py-4">Oprindelse</th>
                                <th class="px-6 py-4">Status</th>
                                <th class="px-6 py-4 text-center">Pris</th>
                                <th class="px-6 py-4 text-right">CO2e / kg</th>
                                <th class="px-6 py-4 text-center">Kvalitet</th>
                                <th class="px-6 py-4 text-right">Score</th>
                            </tr>
                        </thead>
                        <tbody id="pro-table-body" class="divide-y divide-stone-100">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</section>

<script>
    // Data passed from Flask Backend
    const seasonData = {{ season_data | tojson }};

    let currentViewMode = 'simple';
    let currentMonthIndex = new Date().getMonth();
    let filterText = '';
    let sortMethod = 'score';

    function setMonth(monthIndex) {
        currentMonthIndex = monthIndex;

        // Update Buttons
        document.querySelectorAll('button[id^="btn-"]').forEach((btn, idx) => {
            if (idx === monthIndex) {
                btn.className = "px-3 py-2 rounded-lg text-xs font-bold transition-all duration-200 focus:outline-none border border-transparent bg-stone-900 text-white shadow-md transform scale-105";
            } else {
                btn.className = "px-3 py-2 rounded-lg text-xs font-bold transition-all duration-200 focus:outline-none border border-transparent text-stone-500 hover:bg-stone-100 hover:text-stone-900";
            }
        });

        renderContent();
    }

    function updateFilters() {
        filterText = document.getElementById('search-input').value.toLowerCase();
        sortMethod = document.getElementById('sort-select').value;
        renderContent();
    }

    function setViewMode(mode) {
        currentViewMode = mode;

        const btnSimple = document.getElementById('btn-simple');
        const btnPro = document.getElementById('btn-pro');
        const simpleView = document.getElementById('simple-view');
        const proView = document.getElementById('pro-view');
        const strategyBanner = document.getElementById('strategy-banner');

        if (mode === 'simple') {
            btnSimple.className = "px-6 py-2 rounded-md text-xs font-bold uppercase tracking-wider transition-all bg-white shadow-sm text-stone-900 border border-stone-200";
            btnPro.className = "px-6 py-2 rounded-md text-xs font-bold uppercase tracking-wider transition-all text-stone-500 hover:text-stone-900";

            simpleView.classList.remove('hidden');
            proView.classList.add('hidden');
            strategyBanner.classList.add('hidden');
            strategyBanner.classList.remove('opacity-100');
        } else {
            btnPro.className = "px-6 py-2 rounded-md text-xs font-bold uppercase tracking-wider transition-all bg-white shadow-sm text-stone-900 border border-stone-200";
            btnSimple.className = "px-6 py-2 rounded-md text-xs font-bold uppercase tracking-wider transition-all text-stone-500 hover:text-stone-900";

            simpleView.classList.add('hidden');
            proView.classList.remove('hidden');
            strategyBanner.classList.remove('hidden');
            // Small delay for fade in
            setTimeout(() => strategyBanner.classList.add('opacity-100'), 50);
        }

        renderContent();
    }

    function getBadgeColor(type, value) {
        if (type === 'price' || type === 'climate') {
            if (value === 1) return 'bg-green-100 text-green-800';
            if (value === 2) return 'bg-yellow-100 text-yellow-800';
            return 'bg-red-100 text-red-800';
        }
        if (type === 'quality') {
            if (value === 3) return 'bg-green-100 text-green-800';
            if (value === 2) return 'bg-yellow-100 text-yellow-800';
            return 'bg-stone-100 text-stone-600';
        }
        return 'bg-stone-100 text-stone-800';
    }

    function getText(type, value) {
        if (type === 'price') return ['Lav', 'Mellem', 'Høj'][value - 1];
        if (type === 'climate') return ['Lav', 'Mellem', 'Høj'][value - 1];
        if (type === 'quality') return ['Lav', 'God', 'Top'][value - 1];
        return '';
    }

    function renderContent() {
        const data = seasonData[currentMonthIndex];
        document.getElementById('strategy-text').textContent = data.strategy;

        // Filter
        let items = data.items.filter(item =>
            item.name.toLowerCase().includes(filterText) ||
            item.category.toLowerCase().includes(filterText)
        );

        // Sort
        items.sort((a, b) => {
            if (sortMethod === 'score') return b.score - a.score;
            if (sortMethod === 'co2') return a.co2 - b.co2;
            if (sortMethod === 'price') return a.price - b.price;
            return 0;
        });

        if (currentViewMode === 'simple') {
            renderSimpleView(items);
        } else {
            renderProView(items);
        }
    }

    function renderSimpleView(items) {
        const container = document.getElementById('simple-view');
        const categories = { 'Grønt': [], 'Frugt': [], 'Fisk': [] };

        items.forEach(item => {
            if (categories[item.category]) categories[item.category].push(item);
        });

        let html = '';
        for (const [cat, catItems] of Object.entries(categories)) {
            if (catItems.length === 0) continue;

            html += `
            <div class="bg-white rounded-xl p-6 shadow-sm border border-stone-100">
                <h3 class="font-display text-xl text-stone-900 mb-4 border-b border-stone-100 pb-2">${cat}</h3>
                <ul class="space-y-3">
                    ${catItems.map(item => `
                        <li class="flex items-center justify-between text-sm">
                            <span class="text-stone-700 font-medium">${item.name}</span>
                            ${item.quality === 3 ? '<span class="px-2 py-0.5 bg-stone-900 text-white text-[10px] font-bold uppercase tracking-wider rounded">Top</span>' : ''}
                        </li>
                    `).join('')}
                </ul>
            </div>
          `;
        }
        container.innerHTML = html;
    }

    function renderProView(items) {
        const tbody = document.getElementById('pro-table-body');

        if (items.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-8 text-center text-stone-400 italic">Ingen resultater fundet</td></tr>';
            return;
        }

        tbody.innerHTML = items.map((item, index) => {
            const isBestBuy = index === 0 && sortMethod === 'score'; // Only highlight best buy if sorting by score

            return `
            <tr class="hover:bg-stone-50 transition-colors ${isBestBuy ? 'bg-green-50/50' : ''}">
                <td class="px-6 py-4 font-medium text-stone-900 flex items-center gap-2">
                    ${item.name}
                    ${isBestBuy ? '<span class="px-2 py-0.5 bg-green-600 text-white text-[10px] font-bold uppercase tracking-wider rounded shadow-sm">Best Buy</span>' : ''}
                </td>
                <td class="px-6 py-4 text-stone-500">${item.category}</td>
                <td class="px-6 py-4">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-stone-100 text-stone-800">
                        ${item.origin}
                    </span>
                </td>
                <td class="px-6 py-4 text-stone-500">${item.status}</td>
                <td class="px-6 py-4 text-center">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getBadgeColor('price', item.price)}">
                        ${getText('price', item.price)}
                    </span>
                </td>
                <td class="px-6 py-4 text-right font-mono text-xs text-stone-600">
                    ${item.co2.toFixed(2)}
                </td>
                <td class="px-6 py-4 text-center">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getBadgeColor('quality', item.quality)}">
                        ${getText('quality', item.quality)}
                    </span>
                </td>
                <td class="px-6 py-4 text-right font-mono text-xs text-stone-400">
                    ${item.score}%
                </td>
            </tr>
          `;
        }).join('');
    }

    // Init
    setMonth(currentMonthIndex);
</script>
{% endblock %}